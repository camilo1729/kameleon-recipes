export GIT_PROJECT=kameleon
export ROOT_PROJECT=$(dirname $(readlink -f ${BASH_SOURCE[0]}))

export KAMELEON_WORKSPACE="/tmp/kameleon/"
export KAMELEON_LOG=info

alias kameleon="pushd $ROOT_PROJECT && sudo -E bundle exec kameleon"
alias runtest="pushd $ROOT_PROJECT && bundle exec rake"
export RECIPE_DEV_NAME=mymachine

function devrun_chroot_clean() {
    mount \
    | grep rootfs | grep kameleon \
    | py "s='rootfs'" "l=x.split(' ')[2].split(s)[0]" "print(l)" \
    | uniq \
    | xargs -I {} sudo bash "$ROOT_PROJECT"/contrib/scripts/umount-chroot.sh -p -f -a -k -y -c "{}"
}


function devrun_clear() {
    devrun_chroot_clean
    if [ -d "$KAMELEON_WORKSPACE/builds" ]; then
       sudo rm "$KAMELEON_WORKSPACE/builds" -fr 2> /dev/null
    fi
}

function devrun_qemu() {
    path="$KAMELEON_WORKSPACE/builds/$RECIPE_DEV_NAME/${RECIPE_DEV_NAME}_temp.qcow2"
    pushd "$(dirname $path)"
    sudo qemu-system-x86_64 -enable-kvm $(readlink $path)
}

function devrun_build() {
    pushd $KAMELEON_WORKSPACE
    template=${1:-"debian-wheezy-base"}
    devrun_chroot_clean
    kameleon new $RECIPE_DEV_NAME $@ -t $template && kameleon build $RECIPE_DEV_NAME --debug
    if [ -d "$KAMELEON_WORKSPACE/builds/$RECIPE_DEV_NAME" ]; then
        pushd "$KAMELEON_WORKSPACE/builds/$RECIPE_DEV_NAME"
    fi
}
