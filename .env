export GIT_PROJECT=kameleon
export ROOT_PROJECT=$(dirname $(readlink -f ${BASH_SOURCE[0]}))

export KAMELEON_WORKSPACE="/tmp/kameleon/"
export KAMELEON_LOG=info

alias kameleon="builtin cd $ROOT_PROJECT && sudo -E bundle exec kameleon"
alias runtest="cd $ROOT_PROJECT && bundle exec rake"


function devrun_chroot_clean() {
    mount \
    | grep rootfs | grep kameleon \
    | py "s='rootfs'" "l=x.split(' ')[2].split(s)[0]" "print(l)" \
    | uniq \
    | xargs -I {} sudo bash "$ROOT_PROJECT"/contrib/scripts/umount-chroot.sh -p -f -a -k -y -c "{}"
}


function devrun_clear() {
    devrun_chroot_clean
    if [ -d "$KAMELEON_WORKSPACE/builds" ]; then
       sudo rm "$KAMELEON_WORKSPACE/builds" -fr 2> /dev/null
    fi
}


function devrun_build() {
    cd $KAMELEON_WORKSPACE
    devrun_chroot_clean
    name=devmachine
    kameleon new devmachine $@ -t example_recipe && kameleon build $name $@
    if [ -d "$KAMELEON_WORKSPACE/builds/$name" ]; then
        cd "$KAMELEON_WORKSPACE/builds/$name"
    fi
}
