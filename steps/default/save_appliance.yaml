save_appliance:
  
  #TODO test all of these

  #FIXME should take the output path in args
  - save_as_tgz:
    - exec_current: |
        cd $$workdir; tar -zcf $$distrib\_$$arch.tar.gz -C chroot . \
          --numeric-owner --one-file-system --exclude=tmp/* 

  #TODO update this
  - save_as_kameleon:
    # we have to add a postinstall
    - write_file:
      - ../$$distrib\_$$arch.yaml
      - |
        --- 
        name: $$distrib\_$$arch
        version: 1
        visibility: private
        destructive: true
        os: linux
        image: 
          file: $$distrib\_$$arch.tar.gz
          kind: tar
          compression: gzip
        boot: 
          kernel: /vmlinuz
          initrd: /initrd.img
        multipart: false
        filesystem: ext4
        partition_type: 0

  - save_as_raw:
    - exec_appliance: |
        mv $$workdir/image.raw $$workdir/$$distrib\_$$arch.raw
        cd $$workdir; ln -s $$distrib\_$$arch.raw image.raw

  - save_as_vmdk:
    - check_cmd: qemu-img
    - exec_appliance: |
        qemu-img convert -O vmdk $$workdir/image.raw $$workdir/$$distrib\_$$arch.vmdk
    - erb_config:
      - config.vmx.erb
      - $$workdir/$$distrib.vmx

  - save_as_qcow2:
    - check_cmd: qemu-img
    - exec_appliance: |
        qemu-img convert -O qcow2 $$workdir/image.raw $$workdir/$$distrib\_$$arch.qcow2

  - save_as_vdi:
    - check_cmd: VBoxManage
    - exec_appliance: |
        VBoxManage convertdd $$workdir/image.raw $$workdir/$$distrib\_$$arch.vdi
