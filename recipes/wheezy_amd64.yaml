#===============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#===============================================================================
#
# RECIPE: wheezy_amd64.yaml 
# 
# DESCRIPTION: This recipe build an appliance of a complete debian server 
# 
# WARNING: autologin means anyone booting this image get acces WITHOUT password
#
#===============================================================================
---
global:
  # Where Kameleon stores tmp files and appliances
  workdir_base: /img/kameleon/wheezy_amd64/
  # Where Kameleon store the checkpoint file
  checkpoint_file:  /img/kameleon/checkpoint/wheezy_amd64.tgz
  checkpoint_dir:  /img/kameleon/checkpoint/wheezy_amd64/


  # Debian specific
  distrib: debian
  debian_version_name: wheezy
  distrib_repository: http://ftp.fr.debian.org/debian/

  # Image configuration
  arch: amd64
  output_environment_file_system_type: ext4
  img_size: 2G #(see man fallocate)
  extra_packages: "vim bash-completion"

  # Host config
  network_hostname: mydebian
  user_name: kameleon
  user_group: admin
  # set to "kameleon" use the create_passwd.py script to set your own password 
  user_password: '$6$76krqNHd2/VeQZDC$1E9wrN3Sk6sM2vk2wUmqi3zOTkDZokb/ysajArMpYsKzq2/lI/OhQTAg3ow.mflbQOWku2SX4EqZ3yKHTAcdE0'
  generated_rsa_pub_dir: /img/kameleon/keys

contexts: 
  install:
    cmd: |
        chroot $$chroot bash -c "
        DEBIAN_FRONTEND=noninteractive apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get -q -y --force-yes \
        -o Dpkg::Options::='--force-confold' \
        install  %%"
    escape: \\ # The \ will be escape. It allows you to cut long lines with a \

steps:
  # Install
  - bootstrap_if_needed
  - software_install
  - kernel_install

  # Configuration
  - system_config
  - make_swap
  - network_config
  - keyboard_azerty_config
  - create_user
  - generate_user_ssh_key
  - autologin
  - root_passwd
  - root_ssh_config

  # Export
  - clean_appliance
  - build_appliance
  - save_appliance
