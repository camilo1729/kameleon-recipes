#===============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#===============================================================================
#
# RECIPE: debian-7-x86_64
#
# DESCRIPTION: This recipe build an appliance of a complete 64 bits debian
# wheezy server
#
# WARNING: autologin means anyone booting this image get acces WITHOUT password
#
#===============================================================================
---
# Global variables use by Kameleon engine and steps
global:
  ## User varibales : You can define your own global variables here...
  rootfs: $$workdir/rootfs
  cachedir: /var/cache/kameleon/

  ## System variables
  # Distribution
  distrib: debian
  # Architechture
  arch: amd64
  # Set required programs that will be used in the recipe
  requirements: chroot debootstrap

  # Shell session from what we launch exec_local commands
  # We use fakechroot and fakeroot tools to add ability to use chroot
  # and debootstrap commands without root privileges
  out_context: bash

  # Shell session that allows us to connect to the building machine in order
  # to configure it and setup additional programs
  in_context: |
    env -i USER=root HOME=/root PATH=/usr/bin:/usr/sbin:/bin:/sbin
    LC_ALL=POSIX DEBIAN_FRONTEND=noninteractive
    chroot $$rootfs bash

  # You can define your own global variables here...
  user_name: kameleon

# Bootstrap the new system and create context
bootstrap:
  - chroot:
    - version_name: wheezy
    - arch: $$arch
    - repository: http://ftp.fr.debian.org/debian/
    - archive_file: $$cachedir/$$distrib/$$version_name/$$arch/debootstrap.tar.gz
    - include: locales less vim bash-completion zip unzip rsync sudo

# Install and configuration steps
# WARNING: should be independante from the build context
setup:
  # Install
  - software_install:
    - packages: "openssh-server debian-keyring ntp console-tools console-data console-setup"
  - kernel_install:
    - arch: $$arch
  # Configuration
  - system_config:
    - locales: fr_FR en_US
    - lang: fr_FR.UTF-8
    - timezone: Europe/Paris
    - network_hostname: mydebian
    - keyboard_layout: "fr,us"
  - make_swap:
    - swap_size: 2G
  - network_config
  - create_user:
    - user_group: admin
    - user_password: kameleon
  - autologin

# Export the generated appliance in the format of your choice
export:
  - clean_appliance
  - build_appliance:
    - output_environment_file_system_type: ext4
    - img_size: 2G #(see man fallocate)
  - save_appliance:
    - save_as_raw
