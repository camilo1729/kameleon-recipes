# Install extlinux bootloader

- install_syslinux:
  - check_cmd_in: depmod
  - check_cmd_in: dracut
  - check_cmd_in: extlinux
  - exec_in: extlinux --install /boot/extlinux 2>&1
  - exec_in: |
      MBR_PATH=
      PATHS=("/usr/share/syslinux/mbr.bin"
             "/usr/lib/bios/syslinux/mbr.bin"
             "/usr/lib/syslinux/bios/mbr.bin"
             "/usr/lib/extlinux/mbr.bin"
             "/usr/lib/syslinux/mbr.bin")
      for element in "${PATHS[@]}"
      do
        if [ -f "$element" ]; then
          MBR_PATH="$element"
          break
        fi
      done
      if [ "$MBR_PATH" == "" ]; then
        fail "unable to locate the extlinux mbr"
      else
        dd if="$MBR_PATH" of="$(__find_linux_root_device | sed 's/[0-9]*//g')" bs=440  2>&1
      fi
  - write_in:
    - /boot/extlinux/extlinux.conf
    - |
      # extlinux.conf generated by kameleon
      ui menu.c32
      
      menu autoboot Welcome to Fedora. Automatic boot in # second{,s}. Press a key for options.
      menu title Fedora Boot Options.
      menu hidden
      
      timeout 50
      #totaltimeout 9000

  - exec_in: | 
      NAME="$$distrib"
      FIRST=1
      for KERNEL in `ls -1rv /boot/vmlinuz*`; do
          RELEASE=`echo $KERNEL | sed -e 's/^.*vmlinuz-//'`
          echo "LABEL ${NAME^} $RELEASE" >> /boot/extlinux/extlinux.conf
          if [ x$FIRST != x ]; then
              echo "  MENU DEFAULT" >> /boot/extlinux/extlinux.conf
              unset FIRST
          fi
          echo "  INITRD /boot/initramfs-$RELEASE.img" >> /boot/extlinux/extlinux.conf
          echo "  KERNEL $KERNEL" >> /boot/extlinux/extlinux.conf
          echo "  APPEND root=UUID=`blkid -s UUID -o value $(__find_linux_root_device)` rw net.ifnames=0 biosdevname=0" >> /boot/extlinux/extlinux.conf
          echo >> /boot/extlinux/extlinux.conf
      done
