# Install extlinux bootloader

- install_syslinux:
  - check_cmd_in: depmod
  - check_cmd_in: dracut
  - check_cmd_in: extlinux
  - exec_in: DISTRIB_TITLE="$$kameleon_recipe_name"
  - exec_in: VMLINUZ=$(echo /boot/vmlinuz-* | tr ' ' '\n' | grep -v rescue | head -n 1)
  - exec_in: VMLINUZ_VERSION=$(echo $VMLINUZ | sed 's/\/boot\/vmlinuz-//g')
  - exec_in: INITRAMFS="$(echo $VMLINUZ | sed 's/vmlinuz/initramfs/g').img"
  - exec_in: depmod -a $VMLINUZ_VERSION
  - exec_in: dracut -f $INITRAMFS $VMLINUZ_VERSION
  - exec_in: extlinux --install /boot/extlinux 2>&1
  - exec_in: |
      MBR_PATH=
      PATHS=("/usr/share/syslinux/mbr.bin"
             "/usr/lib/bios/syslinux/mbr.bin"
             "/usr/lib/syslinux/bios/mbr.bin"
             "/usr/lib/extlinux/mbr.bin"
             "/usr/lib/syslinux/mbr.bin")
      for element in "${PATHS[@]}"
      do
        if [ -f "$element" ]; then
          MBR_PATH="$element"
          break
        fi
      done
      if [ "$MBR_PATH" == "" ]; then
        fail "unable to locate the extlinux mbr"
      else
        dd if="$MBR_PATH" of="$(__find_linux_root_device | sed 's/[0-9]*//g')" bs=440  2>&1
      fi
  - write_in:
    - /boot/extlinux/extlinux.conf
    - |
      menu autoboot Welcome to ${DISTRIB_TITLE^} $$release $${arch} . Automatic boot in # second{,s}. Press a key for options.
      menu title ${DISTRIB_TITLE^}-$${release}-$${arch} Boot Options.
      default ${DISTRIB_TITLE^}
      timeout 10
      totaltimeout 600
      
      label ${DISTRIB_TITLE^}
      kernel ../`basename $VMLINUZ`
      append ro root=UUID=`blkid -s UUID -o value $(__find_linux_root_device)` console=tty1 console=ttyS0,115200n8
      initrd ../`basename $INITRAMFS`
