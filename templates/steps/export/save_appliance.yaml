# # Save Chroot Appliance

- save_as_tgz:
  - in2out:
    - /etc/fstab
    - ./fstab.bak
  - on_clean:
    - exec_out: rm ./fstab.bak
  - write_in:
    - /etc/fstab
    - |
      # UNCONFIGURED FSTAB FOR BASE SYSTEM
  - pipe:
    - exec_in: |
        tar -zcf - --numeric-owner \
        --exclude=tmp/* \
        --exclude=dev/* \
        --exclude=proc/* \
        --exclude=sys/* \
        --exclude=run/* \
        --exclude=mnt/* \
        --exclude=media/* \
        --exclude=lost+found/* \
        -C / .
    - exec_out: cat > ./$$filename.tar.gz
  - out2in:
    - ./fstab.bak
    - /etc/fstab
  - exec_out: |
      echo "Saved tar.gz appliance to $(pwd)/$$filename.tar.gz"

- save_as_vmdk:
  - check_cmd_out: qemu-img
  - exec_out: |
      qemu-img convert -O vmdk $$kameleon_recipe_name.raw $$filename.vmdk
  - exec_out: echo "Saved vmdk appliance to $(pwd)/$$filename.vmdk"

- save_as_qcow2:
  - check_cmd_out: qemu-img
  - exec_out: |
      qemu-img convert -O qcow2 $$kameleon_recipe_name.raw $$filename.qcow2
  - exec_out: echo "Saved qcow2 appliance to $(pwd)/$$filename.qcow2"

- save_as_vdi:
  - check_cmd_out: VBoxManage
  - exec_out: |
      VBoxManage convertdd $$kameleon_recipe_name.raw $$filename.vdi
  - exec_out: echo "Saved vdi appliance to $(pwd)/$$filename.vdi"
