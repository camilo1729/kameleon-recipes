
- start_qemu:
  - on_checkpoint: redo
  - check_cmd_out: qemu-system-$$qemu_arch
  - exec_out: echo "sync" ; sync
  - exec_out: echo "+++ Starting kvm..."
  - exec_out: |
      if [ $$qemu_enable_kvm = true ]; then
        ENABLE_KVM="-enable-kvm"
      fi
  - exec_out: |
          nohup qemu-system-$$qemu_arch  \
            $ENABLE_KVM -no-reboot \
            -drive file="$$device",cache=none,media=disk,if=virtio,id=drive0 \
            -smp $${qemu_cpu} \
            -m $$qemu_memory_size \
            -rtc base=localtime \
            -net nic,model=virtio -net user \
            -redir tcp:$${qemu_ssh_port}::22 \
            -monitor tcp::$$qemu_monitor_port,server,nowait \
            -vnc :1 \
          1>qemu.log 2>&1 & disown
  - on_export_clean:
    - exec_out: |
          if nc -w 0 -z localhost $$qemu_monitor_port 2>/dev/null
          then
            echo "Shutting down qemu virtual machine..."
            echo "system_reset" | nc localhost $$qemu_monitor_port 1>/dev/null 2>&1
          fi
  - exec_out: |
        echo -n "Waiting for SSH to become available..."
        until ssh-keyscan -p $$qemu_ssh_port localhost  2>&1 | grep -e ssh-rsa -e ssh-dsa &> /dev/null
        do
          sleep 2
          echo -n "."
        done
        echo " ~> OK"
