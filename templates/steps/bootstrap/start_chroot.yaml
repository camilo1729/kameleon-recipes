# # Bootstrap
- mount_chroot:
  - on_checkpoint: redo
  - check_cmd_out: chroot
  - on_bootstrap_init:
    - exec_out: "fail() { echo $@ 1>&2; false; }"
  - on_setup_init:
    - exec_in: "fail() { echo $@ 1>&2; false; }"
  - exec_out: mount -o bind /dev  $$rootfs/dev
  - exec_out: mount -o bind /dev/pts $$rootfs/dev/pts
  - exec_out: mount -t proc /proc  $$rootfs/proc
  - exec_out: mount -t sysfs /sys  $$rootfs/sys
  - on_export_clean:
    - exec_in: echo $$ > /tmp/appliance_pid
    - exec_out: |
        if [ -f "$$rootfs/tmp/appliance_pid" ]; then
          echo "Stopping chroot (PID:$(cat $$rootfs/tmp/appliance_pid))"
          kill -9 $(cat $$rootfs/tmp/appliance_pid)
          rm -f $$rootfs/tmp/appliance_pid
        fi
    - exec_out: echo umount $$rootfs/sys... ; mountpoint -q $$rootfs/sys && umount -f -l $$rootfs/sys  || true
    - exec_out: echo umount $$rootfs/proc... ; mountpoint -q $$rootfs/proc && umount  -f -l $$rootfs/proc  || true
    - exec_out: echo umount $$rootfs/dev/pts... ; mountpoint -q $$rootfs/dev/pts && umount -f -l $$rootfs/dev/pts  || true
    - exec_out: echo umount $$rootfs/dev... ; mountpoint -q $$rootfs/dev && umount -f -l $$rootfs/dev  || true
