- prepare_sshd:
  - exec_out: mkdir -p $$rootfs/root/.ssh/
  - exec_out: cat /root/.ssh/authorized_keys >> $$rootfs/root/.ssh/authorized_keys
  - on_setup_clean:
    - exec_in: rm -rf $$rootfs/root/.ssh/authorized_keys

- mount_chroot:
  - exec_out: mount -o bind /dev  $$rootfs/dev
  - exec_out: mount -o bind /dev/pts $$rootfs/dev/pts
  - exec_out: mount -t proc /proc  $$rootfs/proc
  - exec_out: mount -t sysfs /sys  $$rootfs/sys

- create_fstab:
  - write_out:
    - $$rootfs/etc/fstab
    - |
      # /etc/fstab: static file system information.
      #
      # <file system> <mount point>   <type>  <options>       <dump>  <pass>
      UUID=`blkid -s UUID -o value $${disk_device}1` /               $$filesystem_type    errors=remount-ro  0       1

- install_initial_bootloader:
  - exec_out: extlinux --install $$rootfs/boot/extlinux 2>&1
  - exec_out: MBR_PATH="/usr/lib/extlinux/mbr.bin"
  - exec_out: dd if="$MBR_PATH" of="$$disk_device" bs=440  2>&1
  - write_out:
    - $$rootfs/boot/extlinux/extlinux.conf
    - |
      default linux
      timeout 1
      
      label linux
      kernel ../`basename $$rootfs/boot/vmlinuz*`
      append initrd=../`basename $$rootfs/boot/init*` root=UUID=`blkid -s UUID -o value $${disk_device}1` ro

- umount_all:
  - umount_out: $$rootfs/sys
  - umount_out: $$rootfs/proc
  - umount_out: $$rootfs/dev/pts
  - umount_out: $$rootfs/dev
  - umount_out: $$rootfs

- switch_out2in:
  - exec_local: echo "Rebooting virtualbox vm ($$virtualbox_vmid)"
  - exec_local: VBoxManage controlvm $$virtualbox_vmid poweroff
  - exec_local: VBoxManage modifyvm $$virtualbox_vmid --boot1 disk
  - exec_local: VBoxManage modifyvm $$virtualbox_vmid --boot2 dvd
  - exec_local: VBoxManage startvm  $$virtualbox_vmid --type headless
  - exec_local: |
        echo -n "Waiting for SSH to become available for in_context"
        until ssh-keyscan -4 -p $$virtualbox_ssh_port localhost  2>&1 | grep -e ssh-rsa -e ssh-dsa &> /dev/null
        do
          echo -n "."
          sleep 1
        done
        echo " ~> OK"
  - reload_context: out
  - exec_out: false
