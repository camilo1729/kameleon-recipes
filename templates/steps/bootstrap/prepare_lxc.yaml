# # Bootstrap
- lxc_container_mac_address: 00:16:3e:fb:e1:30
- lxc_container_bridge: lxcbr0
- copy_lxc_config:
  - check_cmd_out: lxc-start lxc-attach lxc-wait
  - write_out:
    - $$lxc_lib_path/$$lxc_container_name/config
    - |
      # Parameters passed to the template:
      lxc.network.type = veth
      lxc.network.hwaddr = 00:16:dd:$(openssl rand -hex 3| sed 's/\(..\)/\1:/g; s/.$//')
      lxc.network.flags = up
      lxc.network.link = lxcbr0
      lxc.rootfs = $$rootfs
      lxc.tty = 4
      lxc.pts = 1024
      lxc.utsname = $$lxc_container_name
      lxc.cap.drop = sys_module mac_admin mac_override sys_time

      # When using LXC with apparmor, uncomment the next line to run unconfined:
      #lxc.aa_profile = unconfined

      lxc.cgroup.devices.deny = a
      # /dev/null and zero
      lxc.cgroup.devices.allow = c 1:3 rwm
      lxc.cgroup.devices.allow = c 1:5 rwm
      # consoles
      lxc.cgroup.devices.allow = c 5:1 rwm
      lxc.cgroup.devices.allow = c 5:0 rwm
      lxc.cgroup.devices.allow = c 4:0 rwm
      lxc.cgroup.devices.allow = c 4:1 rwm
      # /dev/{,u}random
      lxc.cgroup.devices.allow = c 1:9 rwm
      lxc.cgroup.devices.allow = c 1:8 rwm
      lxc.cgroup.devices.allow = c 136:* rwm
      lxc.cgroup.devices.allow = c 5:2 rwm
      # rtc
      lxc.cgroup.devices.allow = c 254:0 rm

      # mounts point
      lxc.mount.entry = proc proc proc nodev,noexec,nosuid 0 0
      lxc.mount.entry = sysfs sys sysfs defaults  0 0


- configure_network:
  - write_out:
    - $$rootfs/etc/network/interfaces
    - |
      auto lo
      iface lo inet loopback
      
      auto eth0
      iface eth0 inet dhcp

- disable_selinux:
    - exec_out: mkdir -p $$rootfs/selinux
    - exec_out: echo 0 > $$rootfs/selinux/enforce

- start_lxc:
  - exec_out: lxc-start -n $$lxc_container_name -d
  - exec_out: lxc-wait -n $$lxc_container_name --state=RUNNING
  - exec_out: false
