# Initialize disk

- partition_disk:
  - check_cmd_out: parted
  - exec_out: |
      echo "Partitioning disk..."
      parted $${disk_device} mklabel msdos
      parted $${disk_device} mkpart primary 0% 100%
      parted $${disk_device} set 1 boot on
  - exec_out: |
      echo Creating root partition...
      mkfs.$$filesystem_type -q $${disk_device}1 || fail cannot create / ext4

- mount_mountdir:
  - on_checkpoint: redo
  - exec_out: mkdir -p $$rootfs
  - exec_out:  "echo Mounting root partition... ;  mount $${disk_device}1 $$rootfs || fail cannot mount /"
  - on_setup_clean:
    - exec_out: "echo try umount $$rootfs... ; mountpoint -q $$rootfs && umount -f -l $$rootfs || true"

- create_fstab:
  - write_out:
    - $$rootfs/etc/fstab
    - |
      # /etc/fstab: static file system information.
      #
      # <file system> <mount point>   <type>  <options>       <dump>  <pass>
      UUID=`blkid -s UUID -o value $${disk_device}1` /               $$filesystem_type    errors=remount-ro  0       1
