- start_vm:
  - on_checkpoint: redo
  - exec_local: echo "Starting virtualbox..."
  - exec_local: VBoxManage startvm  $$virtualbox_vmid --type headless
  - exec_local: |
        echo -n "Waiting for SSH to become available"
        until ssh-keyscan -4 -p $$virtualbox_ssh_port localhost  2>&1 | grep -e ssh-rsa -e ssh-dsa &> /dev/null
        do
          echo -n "."
          sleep 1
        done
        echo " ~> OK"

- shutdown_vm:
  - on_checkpoint: redo
  - on_setup_clean:
    - exec_local: echo "Shutting down virtualbox vm ($$virtualbox_vmid)"
    - exec_local: |
        if VBoxManage list runningvms | grep -q $$virtualbox_vmid; then
          VBoxManage controlvm $$virtualbox_vmid poweroff
        fi

